<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Midnight Drop â€“ Auto Adjust</title>
<style>
body {
  margin: 0;
  min-height: 100vh;
  display: grid;
  place-items: center;
  background: #000;
  color: #fff;
  font-family: system-ui, sans-serif;
}
.countdown {
  font-size: 3rem;
  font-variant-numeric: tabular-nums;
  margin-bottom: 20px;
}
img {
  max-width: 90vw;
  max-height: 50vh;
}
button {
  font-size: 1.2rem;
  padding: 12px 20px;
  border: none;
  border-radius: 999px;
  cursor: pointer;
}
</style>
</head>
<body>
<div>
  <div id="countdown" class="countdown">--:--:--</div>
  <button id="enable">Enable Audio</button>
  <img id="gifImg" src="first.gif" alt="Countdown GIF" />
  <audio id="audio" src="music.mp3" preload="auto"></audio>
</div>
<script>
const audio = document.getElementById('audio');
const enableBtn = document.getElementById('enable');
const countdownEl = document.getElementById('countdown');
const gifImg = document.getElementById('gifImg');
const OFFSET = 6*60 + 14; // 6:14
let audioEnabled = false;

enableBtn.onclick = async () => {
  try {
    audio.volume = 0;
    await audio.play();
    audio.pause();
    audio.currentTime = 0;
    audio.volume = 1;
    audioEnabled = true;
    enableBtn.disabled = true;
    enableBtn.textContent = 'Audio Enabled';

    schedulePlayback();
  } catch(e){console.error(e); alert('Failed to enable audio. Click again.');}
};

function nextMidnight(){
  const now = new Date();
  const midnight = new Date(now);
  midnight.setHours(24,0,0,0);
  return midnight;
}

function format(ms){
  const total = Math.max(0, Math.floor(ms/1000));
  const h = String(Math.floor(total/3600)).padStart(2,'0');
  const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
  const s = String(total%60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

function tick(){
  const now = new Date();
  const midnight = nextMidnight();
  const diff = midnight - now;
  countdownEl.textContent = format(diff);
  if(diff <=0){
    countdownEl.textContent = '00:00:00';
    gifImg.src = 'image.gif';
  }
}
setInterval(tick, 250);

function schedulePlayback(){
  if(!audioEnabled) return;
  const now = new Date();
  const midnight = nextMidnight();
  const msUntilMidnight = midnight - now;

  // If less than 3 mins left, start immediately at adjusted position
  if(msUntilMidnight <= 3*60*1000){
    const elapsed = 3*60*1000 - msUntilMidnight; // how much should have played
    const seekTime = Math.min(OFFSET, elapsed/1000);
    audio.currentTime = seekTime;
    audio.play();
    console.log('Starting immediately, skipped to', seekTime, 'seconds');
    return;
  }

  // normal schedule
  const startTime = Math.max(0, msUntilMidnight - OFFSET*1000);
  setTimeout(async () => {
    try{
      audio.currentTime = 0;
      await audio.play();
    }catch(e){console.error(e);}
  }, startTime);
}
</script>
</body>
</html>
